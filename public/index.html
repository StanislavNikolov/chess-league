<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
html {
  background: radial-gradient(circle at 50% 0%, rgba(247,232,211,1) 0%, rgba(218,190,164,1) 71%, rgba(154,130,118,1) 100%);
    background-size: cover;
}
body {
  margin: 0;
  font-family: Verdana;
}
main {
  width: 100vw;
  /* height: 100vh; */
  margin: 0;
  padding: 20px;
  box-sizing: border-box;


  display: grid;
  grid-gap: 20px;

  grid-template-columns: 2fr 3fr 2fr;
  grid-template-rows: minmax(auto, 200px) 1fr 1fr;
  grid-template-areas: 
    "head head head"
    "hlead live old"
    "blead live upl";
}
#head-tile { grid-area: head; }
#human-leaderboard-tile {
  grid-area: hlead;
  max-height: 30rem;
}
#bot-leaderboard-tile {
  grid-area: blead;
  max-height: 30rem;
}
#old-games-tile {
  grid-area: old;
  max-height: 30rem;
}
#live-games-tile { grid-area: live; }
#upload-tile { grid-area: upl; }

.tile {
  background-color: #f6eae0;
  padding: 8px;
  border-radius: 8px;
  color: #7a4e3c;
  box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
  display: flex;
  flex-direction: column;
}

.leaderboard-item {
  display: flex;
  align-items: center;
  background-color: #eddfcc;
  padding: 6px;
  margin: 6px 2px;
  border-radius: 4px;
}
.place {
  display: inline-block;
  width: 2rem;
  height: 2rem;
  padding-right: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.place img {
  width: 100%;
  height: 100%;
}
.elo {
  margin-left: auto;
  font-size: smaller;
}


h2 {
  text-align: center;
  color: #694638;
}

.crown {
  display: inline-block;
  background: url(/public/crown.svg);
  background-size: contain;
  height: 1rem;
  width: 1rem;
}
.crown.w { transform: translate(11px, -3px) rotate(-45deg); }
.crown.b { transform: translate(-11px, -3px) rotate(45deg); }


#head-tile {
  background: url(/public/head5_q90.jpg);
  background-repeat: no-repeat;
  background-size: cover;
  background-position: center;

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #ecc39f;
}

#human-list, #bot-list, #old-games {
  overflow-y: auto
}

#live-games {
  display: grid;
  grid-gap: 20px;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
}

.game {
  display: flex;
  justify-content: center;
  margin-top: 10px;
  border-bottom: 1px solid #eddfcc;
}
.bot {
  display: inline-block;
  width: 50%;
  margin: 0px 7px;
}
.bot.white {
  text-align: right;
}
#timer {
  font-size: xxx-large;
}
button {
  background-color: #9c8276;
  border: none;
  border-radius: 4px;
  color: white;
  padding: 8px;
  cursor: pointer;
  margin-top: auto;
  font-size: larger;
  transition: 0.2s;
}
button:disabled {
  background-color: #79675f;
  cursor: wait;
}
button:hover {
  background-color: #79675f;
}
dialog {
  background-color: #f6eae0;
  border: 1px solid #9c8276;
  border-radius: 4px;
  box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
  width: 30rem;
}
dialog::backdrop {
  -webkit-backdrop-filter: blur(5px); /* Safari needs this */
  backdrop-filter: blur(5px);
}
dialog form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}
dialog form input, textarea {
  width: 100%;
  box-sizing: border-box;
  border-radius: 4px;
  padding: 6px;
  border: none;
}
#compilation-message {
    font-size: small;
    color: black;
    background: #9c827645;
    padding: 4px;
    border-radius: 4px;
}
.info-heading {
  display: flex;
  gap: 6px;
  fill: #9c8276;
  border-bottom: 1px solid #9c8276;
}
.info-heading img {
  width: 1rem;
}
#compilation-message.hidden {
  display: none;
}

@media only screen and (max-width: 1200px) {
  main {

    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: minmax(auto, 200px) 1fr 1fr 1fr;
    grid-template-areas: 
      "head head head"
      "hlead live live"
      "blead live live"
      "old old upl";
  }
}
@media only screen and (max-width: 800px) {
  h2 {
    font-size: large;
  }
  main {
    padding: 10px;
    grid-gap: 10px;
    font-size: smaller;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 120px 1fr 1fr 1fr;
    grid-template-areas: 
      "head head"
      "hlead blead"
      "live live"
      "old old"
      "upl upl";
  }
}
    </style>
  </head>

  <body>
    <dialog>
      <h2>Upload a new bot</h2>
      <form>
        <label>
          <div>Your name</div>
          <input required name="humanname" type="text" placeholder="Will Smith"></input>
        </label>
        <label>
          <div>Email</div>
          <input required name="email" type="email" placeholder="w.smith@example.com"></input>
        </label>
        <label>
          <div>Bot name</div>
          <input required name="botname" type="text" placeholder="Optimus Prime"></input>
        </label>
        <label>
          <div>Code</div>
          <textarea required name="code" rows="10" placeholder="using ChessChallenge.API;

public class MyBot : IChessBot
{
    public Move Think(Board board, ChessChallenge.API.Timer timer)
    {
        Move[] moves = board.GetLegalMoves();
        ...
"></textarea>
        </label>
        <button type="submit">Go!</button>
        <div id="compilation-message">
          <div class="info-heading">
            <img src="/public/error.svg"></img>
            Your code didn't compile. Here is the compilation message:
          </div>
          <code></code>
        </div>
      </form>
    </dialog>
    <main>
      <div id="head-tile" class="tile">
        <br>
        <span id="timer"></span>
        <span>days left</span>
      </div>
      <div id="human-leaderboard-tile" class="tile">
        <h2>Human Leaderboard</h2>
        <div id="human-list"></div>
      </div>
      <div id="bot-leaderboard-tile" class="tile">
        <h2>Bot Leaderboard</h2>
        <div id="bot-list"></div>
      </div>
      <div id="live-games-tile" class="tile">
        <h2>Live Games</h2>
        <div id="live-games">
        </div>
      </div>
      <div id="old-games-tile" class="tile">
        <h2>Old Games</h2>
        <div id="old-games"></div>
      </div>
      <div id="upload-tile" class="tile">
        <h2>Your Bots</h2>
        <button id="open-upload-dialog">Upload MyBot.cs</button>
      </div>
    </main>

    <script type="module" src="/public/chessboard-element@1.2.0.bundled.mjs"></script>

    <script>
      const $ = s => document.querySelector(s);

      function sanitizeHTML(text) {
        const element = document.createElement('div');
        element.innerText = text;
        return element.innerHTML;
      }

      function renderLeaderboardItem(place, name, elo) {
        const age = (Math.random() * 10).toFixed(0) + ' days';

        let icon = `<b>${place}</b>`
        if (place <= 3) {
          icon = `<img src="/public/medal-${place}.svg"></img>`
        }

        return `
          <div class="leaderboard-item">
            <span class="place">${icon}</span>
            <span>${sanitizeHTML(name)}</span>
            <span class="elo">${elo.toFixed(0)} ELO</span>
          </div>
        `;

      }

      function updateBotLeaderboard() {
        fetch('/api/bots/')
        .then(req => req.json())
        .then(bots => {
          let html = '';
          for(let i = 0;i < bots.length;i ++) {
            html += renderLeaderboardItem(i+1, bots[i].name, bots[i].elo);
          }
          $('#bot-list').innerHTML = html;
        });

        setTimeout(updateBotLeaderboard, 2000);
      }

      function updateHumanLeaderboard() {
        fetch('/api/humans/')
          .then(req => req.json())
          .then(humans => {
            let html = '';
            for(let i = 0;i < humans.length;i ++) {
              html += renderLeaderboardItem(i+1, humans[i].name, humans[i].elo);
            }
            $('#human-list').innerHTML = html;
          });

          setTimeout(updateHumanLeaderboard, 2000);
      }

      function renderGame(g) {
        return `
          <div class="game">
            <span class="bot white">
              ${g.winner === 'w' ? '<span class="crown w"></span>' : ''}
              ${sanitizeHTML(g.wname)}
            </span>
            <span class="bot black">
              ${sanitizeHTML(g.bname)}
              ${g.winner === 'b' ? '<span class="crown b"></span>' : ''}
            </span>
          </div>
        `;
      }

      function updateOldGames() {
        fetch('/api/old-games/')
        .then(req => req.json())
        .then(games => {
          let html = '';
          for(const g of games) {
            html += renderGame(g);
          }
          $('#old-games').innerHTML = html;
        });

        setTimeout(updateOldGames, 2000);
      }

      function renderLiveGame(g) {
        return `
          <div data-game-id=${g.id}>
            <div>${sanitizeHTML(g.wname)}</div>
            <br>
            <chess-board position=${g.fen}></chess-board>
            <br>
            <div>${sanitizeHTML(g.bname)}</div>
          </div>
        `;
      }

      function updateLiveGames() {
        fetch('/api/live-games/')
        .then(req => req.json())
        .then(games => {
          for(const g of games) {
            const existingEl = document.querySelector(`[data-game-id="${g.id}"]`);
            if (!existingEl) {
              $('#live-games').innerHTML += renderLiveGame(g);
            } else {
              existingEl.querySelector('chess-board').setPosition(g.fen);
            }
          }


          for(const drawnGame of document.querySelectorAll(`[data-game-id]`)) {
            const gameId = Number(drawnGame.getAttribute("data-game-id"));
            if(!games.find(g => g.id === gameId)) drawnGame.remove();
          }
          
          for(const cb of document.querySelectorAll('chess-board')) {
            // There is a bug with the chess-board library. It has an element
            // taking space that shouldn't exist.
            console.log(cb.shadowRoot.querySelector('#dragged-pieces'));
            cb.shadowRoot.querySelector('#dragged-pieces')?.remove();
          }
        });

        setTimeout(updateLiveGames, 500);
      };

      updateLiveGames();
      updateBotLeaderboard();
      updateHumanLeaderboard();
      updateOldGames();

      $("#timer").innerHTML = ((new Date('2023-10-01') - new Date()) / (1000 * 60 * 60 * 24)).toFixed(0);


      $("#open-upload-dialog").addEventListener("click", () => {
        $("#compilation-message").classList.toggle('hidden', true);
        $("dialog").showModal();
      });

      $("form").addEventListener("submit", async (ev) => {
        ev.preventDefault();

        $('button[type="submit"]').disabled = true;

        const formData = new FormData($("form"));
        const req = await fetch("/api/upload/", {
          method: "POST",
          body: formData,
        });
        const resp = await req.text();

        $('button[type="submit"]').disabled = false;

        if (req.ok) {
          $("dialog").close();
        } else {
          $("#compilation-message").classList.toggle('hidden', false);
          $("#compilation-message code").innerText = resp;
        }
      });
    </script>
  </body>
</html>

